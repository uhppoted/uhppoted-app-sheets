<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>uhppoted-app-sheets: Authorisation</title>
    <meta charset="UTF-8">
    <link rel="manifest"   href="./manifest.json">
    <link rel="icon"       href="./images/favicon.svg">
    <link rel="stylesheet" href="./css/auth.css" type="text/css" id="css_auth">
  </head>

  <body> 
    <div id="content">
      <header>
        <img id="logo" src="./images/logo.png"  />
      </header>

      <main>
        <div id="instructions">
          <div class="prompt">
            Please open the links below to give <em>uhppoted-app-sheets</em> the
            <br/>
            permissions needed to access to the spreadsheet
          </div>
          <div class="explanation">
            <em>For the curious:</em>
            <ul>
              <li> the <em>Google Sheets</em> permission grants permission to access the spreadsheet data</li>
              <li> the <em>Google Drive</em> permissions grants permission to access the spreadsheet revision information</li>
            </ul>
            <div class="warning">
              Both of the above authorisations are more permissive than is really desirable - please use a Google account
              that is separate from anything deemed valuable.
            </div>
          </div>
          
          <div class="links">
            <div><em>Google Sheets</em></div>
            <a href="{{ .sheets }}" target="_blank" class="link">{{ .sheets }}</a>
            <div id="status-sheets" class="status">Authorised</div>
            
            <div><em>Google Drive</em></div>
            <a  href="{{ .drive  }}" target="_blank" class="link">{{ .drive }}</a>
            <div id="status-drive" class="status">Authorised</div>
          </div>
        </div>
      </main>

      <footer>
      </footer>

    </div>
  </body>

  <script>
    const refresh = function() {
      fetch('/status')
        .then((response) => {
          if (response.ok) {
            return response.json()
          }
        })
        .then((reply) => {
          if (reply && reply.authorised && reply.authorised.sheets) {
            document.querySelector("#status-sheets").classList.add('authorised')
          }

          if (reply && reply.authorised && reply.authorised.drive) {
            document.querySelector("#status-drive").classList.add('authorised')
          }

          if (reply && reply.authorised && reply.authorised.sheets && reply.authorised.drive) {
            clearInterval(refreshTimer)
          }
        })
        .catch((error) => {
          console.error(error)
        })
    }

    const refreshTimer = setInterval(refresh, 1000)
  </script>
</html>


